name: Discord Commit Notification

on:
  push:
    branches:
      - main
      - master
      - develop

jobs:
  notify:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Send Discord Notification
      env:
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
      run: |
        if [ -z "$DISCORD_WEBHOOK" ]; then
          echo "Discord webhook not configured, skipping notification"
          exit 0
        fi
        
        # Get commit info
        COMMIT_MESSAGE=$(git log -1 --pretty=%B)
        COMMIT_AUTHOR=$(git log -1 --pretty=%an)
        COMMIT_URL="${{ github.event.head_commit.url }}"
        COMMIT_SHA=$(git log -1 --pretty=%h)
        BRANCH="${{ github.ref_name }}"
        
        # Get changed files count
        FILES_CHANGED=$(git diff-tree --no-commit-id --name-only -r HEAD | wc -l)
        
        # Build embed JSON
        EMBED_JSON=$(cat <<EOF
        {
          "embeds": [{
            "title": "ðŸ“ New Commit to AethorQuests",
            "description": "**$COMMIT_MESSAGE**",
            "color": 5814783,
            "fields": [
              {
                "name": "Author",
                "value": "$COMMIT_AUTHOR",
                "inline": true
              },
              {
                "name": "Branch",
                "value": "\`$BRANCH\`",
                "inline": true
              },
              {
                "name": "Commit",
                "value": "[\`$COMMIT_SHA\`]($COMMIT_URL)",
                "inline": true
              },
              {
                "name": "Files Changed",
                "value": "$FILES_CHANGED",
                "inline": true
              }
            ],
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%S.000Z)",
            "footer": {
              "text": "AethorQuests"
            }
          }]
        }
        EOF
        )
        
        # Send to Discord
        curl -H "Content-Type: application/json" \
             -d "$EMBED_JSON" \
             "$DISCORD_WEBHOOK"
